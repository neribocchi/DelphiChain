unit Wallet;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs,
  FMX.Controls.Presentation, FMX.StdCtrls, FMX.Memo.Types, FMX.ScrollBox,
  FMX.Memo,web3.utils, FMX.Edit,
  jsonrpcutil,
  Block,
  Chain,
  Node;

type
  TForm3 = class(TForm)
    Button1: TButton;
    Memo1: TMemo;
    Button2: TButton;
    Button3: TButton;
    genblocks: TSwitch;
    genblocks_label: TLabel;
    Timer1: TTimer;
    Label1: TLabel;
    genesis: TEdit;
    Button4: TButton;
    Button5: TButton;
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure genblocksSwitch(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure Button5Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form3: TForm3;
  blockchain:TChain;
implementation

{$R *.fmx}
{$R *.Surface.fmx MSWINDOWS}
{$R *.Windows.fmx MSWINDOWS}

procedure TForm3.Button1Click(Sender: TObject);
var
 g:Tblock;
begin
 memo1.Lines.Clear;
 blockchain:=TChain.create(genesis.Text,100,1);
 g:=blockchain.getGenesis;
 memo1.Lines.add('0-'+toHex(g.getHash)+'->null');



end;

procedure TForm3.Button2Click(Sender: TObject);
begin
  var i:=blockchain.checkConsistancy;
  if i=0 then showmessage('consistent')
  else showmessage('not consistent at block:'+ blockchain.blocks[i].getIndex.ToString+' '+ toHex(blockchain.blocks[i].getPrevHash)+' not match with: '+toHex(blockchain.blocks[i].getPrevBlock.getHash));
end;

procedure TForm3.Button3Click(Sender: TObject);
begin
  blockchain.blocks[1].setHash(TEncoding.UTF8.GetBytes('dddd'));
end;

procedure TForm3.Button4Click(Sender: TObject);
begin
  var b:TNode;
  b:=TNode.create;

end;

procedure TForm3.Button5Click(Sender: TObject);
begin
 TJSONRPCRequest.parse('{"jsonrpc": "2.0", "method": "subtract", "params": [42, 23], "id": 1}');
 Showmessage(TJSONRPCRequest.method);
 Showmessage(TJSONRPCRequest.id);
 Showmessage(TJSONRPCRequest.params.ToJSON);
 TJSONRPCRequest.parse('{"jsonrpc": "2.0", "method": "subtract2", "params": [422,22, 23], "id": 1}');
 Showmessage(TJSONRPCRequest.method);
 Showmessage(TJSONRPCRequest.id);
 Showmessage(TJSONRPCRequest.params.ToJSON);

end;

procedure TForm3.genblocksSwitch(Sender: TObject);
begin
 timer1.Enabled:=genblocks.IsChecked;


end;

procedure TForm3.Timer1Timer(Sender: TObject);
begin
  var b:TBlock;
  b:=blockchain.addBlock(tblock.create(blockchain.lastBlock,TEncoding.UTF8.GetBytes(random(9999999).tostring)));
  memo1.Lines.add(b.getIndex.toString+'-'+toHex(b.getHash)+'->'+toHex(b.getPrevHash));
end;

end.
